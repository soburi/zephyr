/*
 * Copyright (c) 2017, NXP
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include <zephyr/drivers/sensor.h>
#include <zephyr/drivers/i2c.h>
#include <zephyr/drivers/gpio.h>

#define MAX301XX_REG_INT_STS1		0x00
#define MAX301XX_REG_INT_STS2		0x01
#define MAX301XX_REG_INT_EN1		0x02
#define MAX301XX_REG_INT_EN2		0x03
#define MAX301XX_REG_FIFO_WR		0x04
#define MAX301XX_REG_FIFO_OVF		0x05
#define MAX301XX_REG_FIFO_RD		0x06
#define MAX301XX_REG_FIFO_DATA		0x07
#define MAX301XX_REG_FIFO_CFG		0x08
#define MAX301XX_REG_MODE_CFG		0x09
#define MAX301XX_REG_SPO2_CFG		0x0a
#define MAX301XX_REG_LED1_PA		0x0c
#define MAX301XX_REG_LED2_PA		0x0d
#define MAX301XX_REG_LED3_PA		0x0e
#define MAX301XX_REG_PILOT_PA		0x10
#define MAX301XX_REG_MULTI_LED		0x11
#define MAX301XX_REG_TINT		0x1f
#define MAX301XX_REG_TFRAC		0x20
#define MAX301XX_REG_TEMP_CFG		0x21
#define MAX301XX_REG_PROX_INT		0x30
#define MAX301XX_REG_REV_ID		0xfe
#define MAX301XX_REG_PART_ID		0xff

#define MAX301XX_SLOT_LED_MASK		        BIT_MASK(2)

#define MAX301XX_INT_PPG_SHIFT		        6
#define MAX301XX_FIFO_CFG_SMP_AVE_SHIFT		5
#define MAX301XX_FIFO_CFG_FIFO_FULL_SHIFT	0
#define MAX301XX_FIFO_CFG_ROLLOVER_EN_SHIFT	4
#define MAX301XX_MODE_CFG_SHDN_SHIFT	        7
#define MAX301XX_MODE_CFG_RESET_SHIFT	        6
#define MAX301XX_SPO2_ADC_RGE_SHIFT	        5
#define MAX301XX_SPO2_SR_SHIFT		        2
#define MAX301XX_SPO2_PW_SHIFT		        0

#define MAX30101_PART_ID		0x15
#define MAX30102_PART_ID		0x15

#define MAX30101_BYTES_PER_CHANNEL	3
#define MAX30102_BYTES_PER_CHANNEL	3
#define MAX30101_MAX_NUM_CHANNELS	3
#define MAX30102_MAX_NUM_CHANNELS	2

#define MAX301XX_MODEL_30101            1
#define MAX301XX_MODEL_30102            2

#define MAX301XX_MAX_NUM_CHANNELS(n)         UTIL_CAT(UTIL_CAT(MAX3010, n), _MAX_NUM_CHANNELS)

#define MAX30101_MAX_BYTES_PER_SAMPLE	(MAX30101_MAX_NUM_CHANNELS * \
					 MAX30101_BYTES_PER_CHANNEL)

enum max301xx_mode {
	MAX301XX_MODE_HEART_RATE	= 2,
	MAX301XX_MODE_SPO2		= 3,
	MAX301XX_MODE_MULTI_LED		= 7,
};

enum max301xx_slot {
	MAX301XX_SLOT_DISABLED		= 0,
	MAX301XX_SLOT_RED_LED1_PA,
	MAX301XX_SLOT_IR_LED2_PA,
	MAX301XX_SLOT_GREEN_LED3_PA,
	MAX301XX_SLOT_RED_PILOT_PA,
	MAX301XX_SLOT_IR_PILOT_PA,
	MAX301XX_SLOT_GREEN_PILOT_PA,
};

enum max301xx_led_channel {
	MAX301XX_LED_CHANNEL_RED	= 0,
	MAX301XX_LED_CHANNEL_IR,
	MAX301XX_LED_CHANNEL_GREEN,
};

enum max301xx_pw {
	MAX301XX_PW_15BITS		= 0,
	MAX301XX_PW_16BITS,
	MAX301XX_PW_17BITS,
	MAX301XX_PW_18BITS,
};

enum max301xx_smp_ave {
	MAX301XX_SMP_AVE_1              = 0,
	MAX301XX_SMP_AVE_2,
	MAX301XX_SMP_AVE_4,
	MAX301XX_SMP_AVE_8,
	MAX301XX_SMP_AVE_16,
	MAX301XX_SMP_AVE_32,
};

enum max301xx_adc_rge {
	MAX301XX_ADC_RGE_2048           = 0,
	MAX301XX_ADC_RGE_4096,
	MAX301XX_ADC_RGE_8192,
	MAX301XX_ADC_RGE_16384,
};

enum max301xx_sr {
	MAX301XX_SR_50                  = 0,
	MAX301XX_SR_100,
	MAX301XX_SR_200,
	MAX301XX_SR_400,
	MAX301XX_SR_800,
	MAX301XX_SR_1000,
	MAX301XX_SR_1600,
	MAX301XX_SR_3200,
};

enum max301xx_slot_alt {
	MAX301XX_SLOT_NONE              = 0,
	MAX301XX_SLOT_LED1,
	MAX301XX_SLOT_LED2,
	MAX301XX_SLOT_LED3,
};

struct max301xx_config {
	struct i2c_dt_spec i2c;
	uint8_t fifo;
	uint8_t spo2;
	uint8_t led_pa[MAX30101_MAX_NUM_CHANNELS];
	enum max301xx_mode mode;
	enum max301xx_slot slot[4];
	uint8_t model;
};

struct max301xx_data {
	uint32_t raw[MAX30101_MAX_NUM_CHANNELS];
	uint8_t map[MAX30101_MAX_NUM_CHANNELS];
	uint8_t num_channels;
};
